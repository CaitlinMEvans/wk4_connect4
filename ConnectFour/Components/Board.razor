@using System.Drawing
@using ConnectFourGame.Services
@inject GameStateService GameState

<HeadContent>
    <style>
        :root {
            --board-bg: @ColorTranslator.ToHtml(BoardColor);
            --player1: @ColorTranslator.ToHtml(Player1Color);
            --player2: @ColorTranslator.ToHtml(Player2Color);
        }
    </style>
</HeadContent>

<div class="game-wrapper">
    <h1>Connect Four</h1>
    <p>Two players, one board. First to four in a row wins.</p>

    <nav class="drop-row">
        <span title="Drop in column 1" @onclick="() => PlayPiece(0)">â¬‡</span>
        <span title="Drop in column 2" @onclick="() => PlayPiece(1)">â¬‡</span>
        <span title="Drop in column 3" @onclick="() => PlayPiece(2)">â¬‡</span>
        <span title="Drop in column 4" @onclick="() => PlayPiece(3)">â¬‡</span>
        <span title="Drop in column 5" @onclick="() => PlayPiece(4)">â¬‡</span>
        <span title="Drop in column 6" @onclick="() => PlayPiece(5)">â¬‡</span>
        <span title="Drop in column 7" @onclick="() => PlayPiece(6)">â¬‡</span>
    </nav>

    <article class="status-panel">
        <div class="winner-message">@WinnerMessage</div>

        <button class="reset-button"
                style="@ResetStyle"
                @onclick="ResetGame">
            Reset game
        </button>

        <div class="messages">
            <span class="alert-danger">@ErrorMessage</span>
            <span class="alert-info">@CurrentTurn</span>
        </div>
    </article>

    <div>
        <div class="board">
            @for (var i = 0; i < 42; i++)
            {
                <span class="container">
                    <span></span>
                </span>
            }

            @for (var i = 0; i < 42; i++)
            {
                <span class="@Pieces[i]"></span>
            }
        </div>
    </div>

    <section class="wins-summary">
        <div>ðŸ”µ Player 1 wins: @GameState.Player1Wins</div>
        <div>ðŸŸ  Player 2 wins: @GameState.Player2Wins</div>
        <a href="/winstracker" class="wins-link">
            View win tracker â†’
        </a>
    </section>
</div>

@code {
    [Parameter]
    public Color BoardColor { get; set; } = ColorTranslator.FromHtml("#f7d35b");

    [Parameter]
    public Color Player1Color { get; set; } = ColorTranslator.FromHtml("#3498db");

    [Parameter]
    public Color Player2Color { get; set; } = ColorTranslator.FromHtml("#e67e22");

    private string[] Pieces = new string[42];

    private string WinnerMessage = string.Empty;
    private string ErrorMessage = string.Empty;

    private string CurrentTurn =>
        string.IsNullOrEmpty(WinnerMessage)
            ? $"Current Player: Player {GameState.PlayerTurn}"
            : string.Empty;

    private string ResetStyle =>
        string.IsNullOrEmpty(WinnerMessage)
            ? "display:none;"
            : string.Empty;

    protected override void OnInitialized()
    {
        GameState.ResetBoard();
    }

    private void PlayPiece(byte col)
    {
        ErrorMessage = string.Empty;

        try
        {
            var landingRow = GameState.PlayPiece(col);

            var cssClass =
                $"player{GameState.PlayerTurn} col{col} drop{landingRow}";

            Pieces[GameState.CurrentTurn - 1] = cssClass;

            var winState = GameState.CheckForWin();

            WinnerMessage = winState switch
            {
                GameStateService.WinState.Player1_Wins => "Player 1 Wins!",
                GameStateService.WinState.Player2_Wins => "Player 2 Wins!",
                GameStateService.WinState.Tie        => "It's a tie!",
                _                                    => string.Empty
            };

            if (string.IsNullOrEmpty(WinnerMessage))
            {
                GameState.TogglePlayer();
            }
        }
        catch (ArgumentException ex)
        {
            ErrorMessage = ex.Message;
        }
        catch (InvalidOperationException ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private void ResetGame()
    {
        GameState.ResetBoard();
        WinnerMessage = string.Empty;
        ErrorMessage = string.Empty;
        Pieces = new string[42];
    }
}

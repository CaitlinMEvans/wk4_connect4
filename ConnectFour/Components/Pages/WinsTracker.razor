@page "/winstracker"
@using System.Linq
@using ConnectFour.Components
@inject GameState State
@implements IDisposable
@layout Layout.MainLayout
@rendermode InteractiveServer

<div class="tracker-container">
    <h1>Win Tracker</h1>

    <!-- Top stats: wins per player -->
    <div class="stats-grid">
        <div class="stat-card player1-card">
            <div class="stat-icon">ğŸ”µ</div>
            <h2>Player 1</h2>
            <div class="stat-number">@State.Player1Wins</div>
            <div class="stat-label">Wins</div>
        </div>

        <div class="stat-card player2-card">
            <div class="stat-icon">ğŸŸ </div>
            <h2>Player 2</h2>
            <div class="stat-number">@State.Player2Wins</div>
            <div class="stat-label">Wins</div>
        </div>
    </div>

    <!-- Win rate -->
    <div class="win-rate-section">
        <h3>Win Rate</h3>

        @if (TotalGames > 0)
        {
            <div class="win-rate-bars">
                <div class="win-rate-bar" aria-label="Player 1 win rate">
                    <div class="bar-fill player1-bar" style="width:@Player1Percentage%">
                        <span class="bar-label">Player 1 â€“ @Player1Percentage%</span>
                    </div>
                </div>

                <div class="win-rate-bar" aria-label="Player 2 win rate">
                    <div class="bar-fill player2-bar" style="width:@Player2Percentage%">
                        <span class="bar-label">Player 2 â€“ @Player2Percentage%</span>
                    </div>
                </div>
            </div>

            <div class="total-games">
                Total Games: @TotalGames
            </div>
        }
        else
        {
            <div class="no-games">
                No games played yet. Start playing to see statistics!
            </div>
        }
    </div>

    <!-- Recent game history -->
    @if (State.GameHistory.Any())
    {
        <div class="history-section">
            <h3>Recent Games</h3>

            <div class="history-list">
                @foreach (var game in State.GameHistory
                    .OrderByDescending(g => g.Timestamp)
                    .Take(10))
                {
                    <div class="history-item">
                        <span class="history-winner">
                            @(game.Winner == 1 ? "ğŸ”µ Player 1" : "ğŸŸ  Player 2") won
                        </span>
                        <span class="history-time">
                            @game.Timestamp.ToString("MMM dd, HH:mm")
                        </span>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Actions -->
    <div class="tracker-actions">
        <a href="/" class="action-button primary-button">
            â† Back to Game
        </a>

        <button class="action-button tracker-reset-button" @onclick="ResetStats">
            Reset Statistics
        </button>
    </div>
</div>

@code {
    private int TotalGames => State.Player1Wins + State.Player2Wins;

    private int Player1Percentage =>
        TotalGames > 0 ? (State.Player1Wins * 100) / TotalGames : 0;

    private int Player2Percentage =>
        TotalGames > 0 ? (State.Player2Wins * 100) / TotalGames : 0;

    protected override void OnInitialized()
    {
        State.OnStateChanged += StateHasChanged;
    }

    private void ResetStats()
    {
        State.ResetStats();
    }

    public void Dispose()
    {
        State.OnStateChanged -= StateHasChanged;
    }
}

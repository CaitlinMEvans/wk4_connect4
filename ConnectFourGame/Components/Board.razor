@using System.Collections.Generic
@using ConnectFourGame.Services
@inject GameStateService GameState

<div class="game-status">
    @if (GameWinner == 0)
    {
        <span class="@GetCurrentPlayerClass()">
            Current Player: Player @CurrentPlayer
        </span>
    }
    else
    {
        <span class="winner-announcement">
            Player @GameWinner wins!
        </span>
    }
</div>

<div class="board" aria-label="Connect Four board">
    @for (int col = 0; col < 7; col++)
    {
        int currentCol = col;
        <button class="column-button"
                @onclick="() => PlayPiece(currentCol)"
                aria-label="Drop piece in column @(currentCol + 1)"
                disabled="@IsColumnFull(currentCol) || GameWinner != 0">
            â†“
        </button>
    }

    @for (int row = 0; row < 6; row++)
    {
        for (int col = 0; col < 7; col++)
        {
            <GamePiece Row="@row"
                       Column="@col"
                       CurrentPlayer="@Grid[col, row]"
                       GameWinner="@GameWinner"
                       WinningCells="@WinningCells" />
        }
    }
</div>

<div class="game-controls">
    <button class="reset-button" @onclick="ResetGame">
        New Game
    </button>
</div>

@code {
    private int[,] Grid = new int[7, 6];
    private int CurrentPlayer = 1;
    private int GameWinner = 0;
    private List<(int column, int row)> WinningCells = new();

    protected override void OnInitialized()
    {
        ResetGame();
    }

    private void ResetGame()
    {
        Grid = new int[7, 6];
        CurrentPlayer = 1;
        GameWinner = 0;
        WinningCells.Clear();
    }

    private bool IsColumnFull(int column)
        => Grid[column, 0] != 0;

    private string GetCurrentPlayerClass()
        => CurrentPlayer == 1 ? "player1-text" : "player2-text";

    private void PlayPiece(int column)
    {
        if (GameWinner != 0)
            return;

        // drop piece to lowest empty row
        for (int row = 5; row >= 0; row--)
        {
            if (Grid[column, row] == 0)
            {
                Grid[column, row] = CurrentPlayer;
                CheckForWinner(column, row);

                if (GameWinner != 0)
                {
                    GameState.RecordWin(GameWinner);
                }
                else
                {
                    CurrentPlayer = CurrentPlayer == 1 ? 2 : 1;
                }

                return;
            }
        }
    }

    private void CheckForWinner(int col, int row)
    {
        int player = Grid[col, row];

        var h = CheckDirection(col, row, 1, 0);
        if (h.Count >= 4) { SetWinner(player, h); return; }

        var v = CheckDirection(col, row, 0, 1);
        if (v.Count >= 4) { SetWinner(player, v); return; }

        var d1 = CheckDirection(col, row, 1, 1);
        if (d1.Count >= 4) { SetWinner(player, d1); return; }

        var d2 = CheckDirection(col, row, 1, -1);
        if (d2.Count >= 4) { SetWinner(player, d2); return; }
    }

    private void SetWinner(int player, List<(int col, int row)> cells)
    {
        GameWinner = player;
        WinningCells = cells;
    }

    private List<(int col, int row)> CheckDirection(int col, int row, int dCol, int dRow)
    {
        int player = Grid[col, row];
        var cells = new List<(int, int)> { (col, row) };

        // forward
        int c = col + dCol, r = row + dRow;
        while (c >= 0 && c < 7 && r >= 0 && r < 6 && Grid[c, r] == player)
        {
            cells.Add((c, r));
            c += dCol; r += dRow;
        }

        // backward
        c = col - dCol; r = row - dRow;
        while (c >= 0 && c < 7 && r >= 0 && r < 6 && Grid[c, r] == player)
        {
            cells.Add((c, r));
            c -= dCol; r -= dRow;
        }

        return cells;
    }
}
